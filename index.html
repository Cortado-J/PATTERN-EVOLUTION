<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orbifolder - Pattern Evolution</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #1a1a1a;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: Arial, sans-serif;
      overflow: hidden;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    
    #canvas-container {
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
    }

    canvas {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }
    
    #group-label {
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 42px;
      font-weight: 700;
      color: #ffffff;
      background: rgba(0, 0, 0, 0.78);
      padding: 10px 22px;
      border-radius: 6px;
      border: 2px solid rgba(255, 255, 255, 0.85);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: opacity 0.25s ease-in-out;
      pointer-events: none;
      z-index: 10;
      max-width: calc(100% - 48px);
      text-align: center;
      white-space: nowrap;
    }
    
    #group-label.visible {
      opacity: 1;
    }
    
    @media (max-height: 600px) {
      #group-label {
        font-size: 36px;
        bottom: 10px;
      }
    }
    
    @media (max-width: 480px) {
      #group-label {
        font-size: 32px;
      }
    }
  </style>
</head>
<body>
  <div id="canvas-container">
    <div id="group-label"></div>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
  <script src="pattern.js"></script>
  <script src="genome.js"></script>
  
  <script>
    const targetAspect = 4 / 6; // width / height (portrait bias) .
    const PATTERN_REPEATS_X = 3;
    const PATTERN_REPEATS_Y = 6;

    let palettes = {
      warm: ["#e63946", "#f1faee", "#a8dadc", "#ffbe0b", "#fb5607"],
      cool: ["#457b9d", "#1d3557", "#a8dadc", "#118ab2", "#06d6a0"],
      earth: ["#2a9d8f", "#e9c46a", "#f4a261", "#264653", "#dda15e"],
      vivid: ["#ffb703", "#fb8500", "#023047", "#8ecae6", "#219ebc"],
    };

    let baseGenome = null;
    let currentGenome = null;
    let state = "pattern"; // 'pattern' or 'showing-group'

    let containerEl;
    let groupLabelEl;
    let canvas;
    let pg;

    function cloneGenome(g) {
      return JSON.parse(JSON.stringify(g));
    }

    function computeViewportRect() {
      const vw = window.innerWidth || width;
      const vh = window.innerHeight || height;
      let rectWidth = vw;
      let rectHeight = rectWidth / targetAspect;
      if (rectHeight > vh) {
        rectHeight = vh;
        rectWidth = rectHeight * targetAspect;
      }
      return {
        width: Math.max(1, Math.round(rectWidth)),
        height: Math.max(1, Math.round(rectHeight)),
      };
    }

    function applyContainerSize() {
      const rect = computeViewportRect();
      if (containerEl) {
        containerEl.style.width = `${rect.width}px`;
        containerEl.style.height = `${rect.height}px`;
      }
      return rect;
    }

    function setup() {
      containerEl = document.getElementById("canvas-container");
      groupLabelEl = document.getElementById("group-label");

      const { width: w, height: h } = applyContainerSize();
      canvas = createCanvas(w, h);
      canvas.parent(containerEl);
      angleMode(RADIANS);
      noLoop();

      pg = createGraphics(w, h);

      generateNewPattern();
      drawScreen();
    }

    function draw() {
      // Rendering is event-driven via drawScreen()
    }

    function updateCurrentGenomeScale() {
      if (!baseGenome) return;
      const rect = computeViewportRect();
      const baseCell = estimateCellSize(baseGenome);
      const safeCellW = Math.max(1, baseCell.w);
      const safeCellH = Math.max(1, baseCell.h);
      const horizontalSpan = safeCellW * PATTERN_REPEATS_X;
      const minimumVerticalSpan = 2 * horizontalSpan;
      const configuredVerticalSpan = safeCellH * PATTERN_REPEATS_Y;
      const verticalSpan = Math.max(minimumVerticalSpan, configuredVerticalSpan);
      let scaleFactor = Math.min(
        rect.width / horizontalSpan,
        rect.height / verticalSpan
      );
      if (!Number.isFinite(scaleFactor) || scaleFactor <= 0) {
        scaleFactor = 1;
      }
      const scaledGenome = cloneGenome(baseGenome);
      scaledGenome.motifScale = baseGenome.motifScale * scaleFactor;
      currentGenome = scaledGenome;
    }

    function renderPattern() {
      if (!currentGenome) return;
      const rect = computeViewportRect();
      if (!pg) {
        pg = createGraphics(rect.width, rect.height);
      }
      if (pg.width !== rect.width || pg.height !== rect.height) {
        pg.resizeCanvas(rect.width, rect.height);
      }
      pg.background(20);
      pg.push();
      pg.translate(pg.width / 2, pg.height / 2);
      drawWallpaperOn(pg, currentGenome);
      pg.pop();
    }

    function drawScreen() {
      background(20);
      if (currentGenome && pg) {
        image(pg, 0, 0, width, height);
      }
      if (!groupLabelEl) return;
      if (state === "showing-group" && currentGenome) {
        groupLabelEl.textContent = currentGenome.group;
        groupLabelEl.classList.add("visible");
      } else {
        groupLabelEl.classList.remove("visible");
      }
    }

    function generateNewPattern() {
      baseGenome = randomGenome();
      state = "pattern";
      updateCurrentGenomeScale();
      renderPattern();
      drawScreen();
    }

    function handleInteraction() {
      if (state === "pattern") {
        state = "showing-group";
        drawScreen();
      } else {
        generateNewPattern();
      }
    }

    function mousePressed() {
      handleInteraction();
      return false;
    }

    function touchStarted() {
      handleInteraction();
      return false;
    }

    function windowResized() {
      const { width: w, height: h } = applyContainerSize();
      resizeCanvas(w, h);
      if (pg) {
        pg.resizeCanvas(w, h);
      } else {
        pg = createGraphics(w, h);
      }
      updateCurrentGenomeScale();
      renderPattern();
      drawScreen();
    }
  </script>
</body>
</html>
